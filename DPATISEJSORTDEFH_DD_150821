SELECT
HB3 YEAR(sejour.sejo_dat_fin) AS ANNEE_SORTIE,
sejour.sejo_num_sej AS NUM_SEJ_H,
patient.pati_nip AS NIPP,
patient.pati_sexe AS SEXE,
(YEAR(sejour.sejo_dat_fin)-YEAR(patient.pati_dat_nai)) AS AGE,
TO_CHAR(sejour.sejo_dat_deb,'dd-mm-yyyy HH24:Mi') ||'-'|| TO_CHAR(sejour.sejo_dat_fin,'dd-mm-yyyy HH24:Mi') AS DEBFIN_SEJ_H,
(SELECT TO_CHAR(WM_CONCAT(adresse.adre_cod_pos ||'-'|| adresse.adre_ville))
       FROM Ide_adresse AS adresse
       WHERE adresse.adre_id_obj = patient.pati_id_pati 
       AND adresse.bas_catalogue_gen.id = '161') AS DOMICILE_COMMUNE,
CASE WHEN NOT EXISTS (SELECT acte.id
    FROM patient.pms_edgars AS redg
    JOIN redg.pms_edgar_actes AS acte
    JOIN acte.bas_catalogue_gen_by_Edgr_id_cage_nature as type
    JOIN acte.bas_catalogue_gen_by_Edgr_id_cage_lieu AS lieu
    WHERE SUBSTR(type.cage_code,1,1) IN('E','G','A')
    AND lieu.cage_code NOT IN('L09','L10')
    AND acte.edgr_date > sejour.sejo_dat_fin) THEN 'OUI' ELSE 'NON' END AS ZEROACTE_POSTH,
CASE WHEN NOT EXISTS (SELECT acte.id
    FROM patient.pms_edgars AS redg
    JOIN redg.pms_edgar_actes AS acte
    JOIN acte.bas_catalogue_gen_by_Edgr_id_cage_nature as type
    JOIN acte.bas_catalogue_gen_by_Edgr_id_cage_lieu AS lieu
    WHERE SUBSTR(type.cage_code,1,1) IN('E','G','A')
    AND lieu.cage_code NOT IN('L09','L10')
    AND acte.edgr_date > sejour.sejo_dat_fin) 
    AND NOT EXISTS(SELECT sejour2.id
    FROM patient.ide_sejours AS sejour2
    JOIN sejour2.bas_catalogue_pers_by_Sejo_id_cape_ven AS typesej2
    JOIN sejour2.bas_etablissement_by_Sejo_id_etab_con AS etab2    
    WHERE etab2.id = etab
    AND sejour2.sejo_dat_deb > sejour.sejo_dat_fin
    AND typesej2.cape_code = 'H'
    AND sejour2.sejo_ind_incomplet != 1
    AND sejour2.sejo_dat_sup IS NULL) THEN 'OUI' ELSE 'NON' END AS ZEROACTEZEROREHOSP_POSTH,
CASE WHEN YEAR(patient.dat_cre) = YEAR(sejour.sejo_dat_fin) THEN 'OUI' ELSE 'NON' END AS NX_PATI_DE_LANNEE,
CASE WHEN patient.pati_dat_dec IS NOT NULL AND patient.pati_ind_dec IS NOT NULL THEN 'OUI' ELSE 'NON' END AS PATIENT_DECEDE

FROM
Ide_patient AS patient
JOIN patient.ide_sejours AS sejour
JOIN sejour.bas_uf_by_Sejo_id_unfo_heb_courant AS ufh
JOIN sejour.bas_catalogue_pers_by_Sejo_id_cape_ven AS typesej
JOIN sejour.bas_etablissement_by_Sejo_id_etab_con AS etab
JOIN sejour.ide_mouvements AS mouv
JOIN mouv.bas_catalogue_pers_by_Mouv_id_cape_sor AS modsortie

WHERE
etab.id = <ETAB>
AND patient.pati_nip != '140374'
AND sejour.sejo_ind_incomplet != 1
AND sejour.sejo_dat_sup IS NULL
AND typesej.cape_code = 'H'
AND mouv.mouv_dat_mou = (SELECT MAX(mou2.mouv_dat_mou) FROM sejour.ide_mouvements as mou2)
AND modsortie.cape_code NOT IN ('ABL','ABSC','ABSCN','CS','SP')
AND sejour.sejo_dat_fin BETWEEN INVITE(D: Sorties définitives de séjours H entre le ) AND INVITE(D: et le )

GROUP BY
ORDER BY sejour.sejo_dat_deb, patient.pati_nip
