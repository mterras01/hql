// CODE: CANDURMOYMES_REGISTRE_SWM_080521 
// Libelle: Compteur annuel durée moyenne des mesures/type registre_DD_080521


SELECT
HB3 YEAR(cal.dcal_date) AS ANNEE,
isre.isre_typ_registre AS TYPE_REGISTRE,
COUNT(DISTINCT isre.isre_num_fiche) AS NB_MESURES,
COUNT(DISTINCT pati.id) AS NB_PATIENTS,
SUM(NVL(isre.isre_dat_fin, current_date)-isre.isre_dat_deb) AS DUREE_ISRE_JOUR,
SUM((NVL(isre.isre_dat_fin, current_date)-isre.isre_dat_deb)*24) AS DUREE_ISRE_HEURE,
(SUM((NVL(isre.isre_dat_fin, current_date)-isre.isre_dat_deb)*24)/COUNT(DISTINCT isre.isre_num_fiche)) AS DUR_MOY_HEURE,
(SUM(NVL(isre.isre_dat_fin, current_date)-isre.isre_dat_deb)/COUNT(DISTINCT isre.isre_num_fiche)) AS DUR_MOY_JOUR

FROM
Sid_psy_calendar AS cal
,Med_isolement_registre as isre
inner join isre.med_isolement_mesure_by_Isre_id_isme as isme
inner join isme.ide_sejour_by_Isme_id_sejo as sejo
JOIN sejo.bas_catalogue_pers_by_Sejo_id_cape_ven AS typesej
JOIN sejo.bas_uf_by_Sejo_id_unfo_med_courant as ufm
inner join isme.med_isolement_contentions_by_Isco_id_isme as isco
inner join isme.ide_patient_by_Isme_id_pati as pati
JOIN pati.bas_etablissement AS etab

WHERE
etab.id = <ETAB>
AND cal.dcal_date= INVITE(D: mesures en cours entre le -mettre le 1er- )
AND NVL(isre.isre_dat_fin, current_date) >= INVITE(D: mesures en cours entre le -mettre le 1er- )
AND isre.isre_dat_deb <= INVITE(D: et le -mettre le 31/12 de l'année- )
AND YEAR(INVITE(D: mesures en cours entre le -mettre le 1er- )) = YEAR(INVITE(D: et le -mettre le 31/12 de l'année- ))
AND isme.isme_dat_invalid IS NULL
and ( ( isco.isco_eta_mesure = 'I' and isco.isco_dat_validation is not null)
       or isco.isco_eta_mesure in ('D','R','C')
    )
and not exists (select isco2.id 
                from Med_isolement_contention as isco2
                where isco2.med_isolement_mesure_by_Isco_id_isme.id = isme.id
                and isco2.isco_dat_validation > isco.isco_dat_validation)
AND pati.pati_nip != '140374'
AND ufm.id = INVITE(b:UF_MED_FILT_VAL: Mesures dans cette unité)
AND ufm.id != INVITE(b:UF_MED_FILT_VAL: Mesures hors cette unité)
AND pati.pati_nip LIKE INVITE(t: mesures pour ce patient IPP avec joker %)

GROUP BY
YEAR(cal.dcal_date), isre.isre_typ_registre
