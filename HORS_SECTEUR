// CODE: LPATIAVECADRHORSREGARA_160521
// Libelle: Liste des Patients BASE AVEC adresse hors r√©gion ARA_160521

SELECT:
HB3 sejourtest.sejo_id_sejo, sejourtest.sejo_id_sejo,
TO_CHAR(current_date,'dd-mm-yyyy') AS JOUR_ANALYSE,
patient.pati_sexe AS SEXE,
COUNT(DISTINCT patient.id) AS PATIENTS,
REPLACE(ROUND(AVG(YEAR(current_date)-YEAR(patient.pati_dat_nai)),1),'.',',') AS AGE_MOYEN,
SUM(CASE WHEN EXISTS(SELECT sejour.id
    FROM patient.ide_sejours AS sejour
    JOIN sejour.bas_etablissement_by_Sejo_id_etab_con AS etab2
    JOIN sejour.bas_catalogue_pers_by_Sejo_id_cape_ven AS typsej
    WHERE typsej.cape_code = 'H'
    AND sejour.sejo_dat_sup is null
    AND sejour.sejo_ind_incomplet != '1') THEN 1 ELSE 0 END) AS NB_PATI_H

FROM:
Ide_patient AS patient
JOIN patient.bas_etablissement AS etab
,Ide_adresse AS adresse
,Ide_sejour as sejourtest

WHERE:
etab.id = <ETAB>
AND sejourtest.sejo_num_sej = '000191962'
AND patient.pati_nip != '140374'
AND adresse.adre_id_obj = patient.id
AND adresse.bas_catalogue_gen.id = '161'
AND SUBSTR(adresse.adre_cod_pos,1,2) NOT IN('03','63','15','43','42','07','69','26','01','38','73','74')

GROUP BY:
sejourtest.sejo_id_sejo, sejourtest.sejo_id_sejo, TO_CHAR(current_date,'dd-mm-yyyy'), patient.pati_sexe
